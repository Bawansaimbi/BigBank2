@{
    ViewBag.Title = "Open Loan Account";
}

<div class="container py-4">
    <h2>Open Loan Account</h2>
    @if (TempData["Error"] != null) { <div class="alert alert-danger">@TempData["Error"]</div> }
    @if (TempData["Success"] != null) { <div class="alert alert-success">@TempData["Success"]</div> }

    @using (Html.BeginForm("OpenLoanAccount","Home",FormMethod.Post))
    {
        @Html.AntiForgeryToken()
        <div class="row g-3">
            <div class="col-12 col-md-6">
                <label class="form-label">Customer ID</label>
                <input name="CustID" id="custIdInput" class="form-control" placeholder="Cust..." value="@ViewBag.LastCustID" required />
            </div>
            <div class="col-12 col-md-6">
                <label class="form-label">Loan Amount (Rs)</label>
                <input name="LoanAmount" type="number" min="10000" step="0.01" class="form-control" placeholder="Min 10,000" required />
            </div>
        </div>
        
        <div class="row g-3 mt-2">
            <div class="col-12 col-md-4">
                <label class="form-label">Interest Rate (%)</label>
                <input name="InterestRate" type="number" min="0.01" max="30" step="0.01" class="form-control" placeholder="e.g., 8.5" required />
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Tenure (Years)</label>
                <input name="Tenure" type="number" min="1" max="30" class="form-control" placeholder="e.g., 5" required />
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Start Date</label>
                <input name="StartDate" type="date" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
            </div>
        </div>

        <div class="mt-3">
            <input id="custName" class="form-control mb-2" readonly placeholder="Customer name will appear here" />
        </div>

        <div class="mt-3">
            <button class="btn btn-primary" type="submit">Open Loan Account</button>
            <a href="@Url.Action("ViewLoanAccounts","Home")" class="btn btn-secondary">Cancel</a>
        </div>
    }

    @if (ViewBag.NewLoanId != null)
    {
        <div class="alert alert-success mt-3">
            <h5>Congratulations!</h5>
            <p>New loan account <strong>@ViewBag.NewLoanId</strong> has been created successfully.</p>
        </div>
    }
</div>

<script>
    (function(){
        var input = document.getElementById('custIdInput');
        var nameBox = document.getElementById('custName');
        if (!input) return;
        
        function lookup(){
            var id = input.value.trim();
            if (!id) { if (nameBox) nameBox.value = ''; return; }
            
            fetch('/Home/LookupCustomerName?id=' + encodeURIComponent(id))
                .then(function(res){ return res.json(); })
                .then(function(data){ 
                    if (data && nameBox) nameBox.value = data.name || 'Not found'; 
                })
                .catch(function(){ if (nameBox) nameBox.value = 'Error'; });
        }
        
        input.addEventListener('blur', lookup);
        input.addEventListener('change', lookup);

        // Trigger lookup on page load if CustID is prefilled
        var last = '@(ViewBag.LastCustID ?? "")';
        if (last && input) {
            input.value = last;
            lookup();
        }
    })();
</script>
