using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Web;
using System.Web.Mvc;
using BigBank.Models;
using BigBank.Filters;

namespace BigBank.Controllers
{
    public class HomeController : Controller
    {
        [AllowAnonymous]
        public ActionResult Index()
        {
            return RedirectToAction("Login");
        }

        [AllowAnonymous]
        public ActionResult Contact()
        {
            ViewBag.Message = "Your contact page.";

            return View();
        }

        // GET: Login
        [AllowAnonymous]
        public ActionResult Login()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [AllowAnonymous]
        public ActionResult Login(string username, string password, string userType)
        {
            if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password) || string.IsNullOrWhiteSpace(userType))
            {
                ModelState.AddModelError("", "Please provide username, password and user type.");
                return View();
            }

            var hashed = HashPassword(password);

            using (var db = new BigBankEntities())
            {
                if (userType == "Customer")
                {
                    var cust = db.Customers.FirstOrDefault(c => c.Username == username);
                    if (cust != null && cust.Password != null && cust.Password.SequenceEqual(hashed))
                    {
                        Session["UserType"] = "Customer";
                        Session["UserID"] = cust.CustID;
                        Session["Username"] = cust.Username;
                        // bind session to UA and IP for extra safety
                        Session["UserAgent"] = Request.UserAgent ?? string.Empty;
                        Session["IP"