using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Web;
using System.Web.Mvc;
using BigBank.Models;
using BigBank.Filters;

namespace BigBank.Controllers
{
    public class HomeController : Controller
    {
        [AllowAnonymous]
        public ActionResult Index()
        {
            return RedirectToAction("Login", "Account");
        }

        [AllowAnonymous]
        public ActionResult Contact()
        {
            ViewBag.Message = "Your contact page.";

            return View();
        }

        // GET: Login
        [AllowAnonymous]
        public ActionResult Login()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [AllowAnonymous]
        public ActionResult Login(string username, string password, string userType)
        {
            if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password) || string.IsNullOrWhiteSpace(userType))
            {
                ModelState.AddModelError("", "Please provide username, password and user type.");
                return View();
            }

            var hashed = HashPassword(password);

            using (var db = new BigBankEntities())
            {
                if (userType == "Customer")
                {
                    var cust = db.Customers.FirstOrDefault(c => c.Username == username);
                    if (cust != null && cust.Password != null && cust.Password.SequenceEqual(hashed))
                    {
                        Session["UserType"] = "Customer";
                        Session["UserID"] = cust.CustID;
                        Session["Username"] = cust.Username;
                        // bind session to UA and IP for extra safety
                        Session["UserAgent"] = Request.UserAgent ?? string.Empty;
                        Session["IP"] = Request.UserHostAddress ?? string.Empty;
                        Session["LastActivityUtc"] = DateTime.UtcNow;
                        return RedirectToAction("CustomerHome");
                    }
                }
                else
                {
                    var emp = db.Employees.FirstOrDefault(e => e.Username == username);
                    if (emp != null && emp.Password != null && emp.Password.SequenceEqual(hashed))
                    {
                        if ((userType == "Employee" && emp.EmpType == "E") || (userType == "Manager" && emp.EmpType == "M"))
                        {
                            Session["UserType"] = emp.EmpType == "M" ? "Manager" : "Employee";
                            Session["UserID"] = emp.EmpID;
                            Session["Username"] = emp.Username;
                            Session["DeptID"] = emp.DeptID;
                            Session["UserAgent"] = Request.UserAgent ?? string.Empty;
                            Session["IP"] = Request.UserHostAddress ?? string.Empty;
                            Session["LastActivityUtc"] = DateTime.UtcNow;
                            
                            if (emp.EmpType == "M")
                                return RedirectToAction("ManagerHome");
                            

                            // Route employees to Employee controller based on department
                            var deptId = (emp.DeptID ?? "").Trim().ToUpper();
                            switch (deptId)
                            {
                                case "SB":
                                case "DEPT01":
                                    return RedirectToAction("SavingsEmployeeHome", "Employee");
                                case "FD":
                                    return RedirectToAction("FDEmployeeHome", "Employee");
                                case "LN":
                                    return RedirectToAction("LoanEmployeeHome", "Employee");
                                default:
                                    return RedirectToAction("Index", "Employee");
                            }
                        }
                    }
                }
            }

            ModelState.AddModelError("", "Invalid username, password or user type.");
            return View();
        }

        // GET: Register
        [AllowAnonymous]
        public ActionResult Register()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [AllowAnonymous]
        public ActionResult Register(RegisterViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);

            // Additional server-side validations to match manager AddCustomer
            if (!System.Text.RegularExpressions.Regex.IsMatch(model.CustName ?? string.Empty, "^[A-Za-z ]+$$"))
            {
                ModelState.AddModelError("CustName", "Name must contain letters and spaces only.");
            }

            var minDob = DateTime.Today.AddYears(-18);
            if (model.DOB > minDob)
            {
                ModelState.AddModelError("DOB", "You must be at least 18 years old to register.");
            }

            var pan = (model.PAN ?? string.Empty).Trim().ToUpper();
            if (!System.Text.RegularExpressions.Regex.IsMatch(pan, "^[A-Z]{4}[0-9]{4}$"))
            {
                ModelState.AddModelError("PAN", "PAN must be in format ABCD1234 (4 letters followed by 4 digits).");
            }

            var phone = System.Text.RegularExpressions.Regex.Replace(model.PhoneNum ?? string.Empty, "\\s+", "");
            if (!System.Text.RegularExpressions.Regex.IsMatch(phone, "^[0-9]{10}$"))
            {
                ModelState.AddModelError("PhoneNum", "Phone number must be exactly 10 digits.");
            }

            using (var db = new BigBankEntities())
            {
                // unique username across customers and employees
                if (db.Customers.Any(c => c.Username == model.Username) || db.Employees.Any(e => e.Username == model.Username))
                {
                    ModelState.AddModelError("Username", "Username already exists. Please choose a different username.");
                }

                // PAN must not exist in employees
                if (db.Employees.Any(e => e.PAN == pan))
                {
                    ModelState.AddModelError("PAN", "PAN belongs to an employee or manager. Employees and managers cannot register as customers.");
                }

                // PAN must not exist in customers
                if (db.Customers.Any(c => c.PAN == pan))
                {
                    ModelState.AddModelError("PAN", "A customer with this PAN already exists.");
                }

                // Phone must be unique among customers
                if (db.Customers.Any(c => c.PhoneNum == phone))
                {
                    ModelState.AddModelError("PhoneNum", "Phone number is already registered.");
                }

                if (!ModelState.IsValid)
                {
                    // return view with validation messages
                    return View(model);
                }

                var sql = @"INSERT INTO Customer (CustName, Gender, DOB, PAN, PhoneNum, Address, Username, Password, CreatedOn)
                            VALUES (@name, @gender, @dob, @pan, @phone, @addr, @username, @pwd, @created)";

                var pwd = HashPassword(model.Password);

                var parameters = new[] {
                    // sizes/types aligned with EDMX / DB schema
                    new SqlParameter("@name", SqlDbType.NVarChar, 50) { Value = (object)model.CustName ?? DBNull.Value },
                    new SqlParameter("@gender", SqlDbType.Char, 1) { Value = (object)model.Gender ?? DBNull.Value },
                    new SqlParameter("@dob", SqlDbType.Date) { Value = model.DOB },
                    // PAN is CHAR(8) in database
                    new SqlParameter("@pan", SqlDbType.Char, 8) { Value = (object)pan ?? DBNull.Value },
                    new SqlParameter("@phone", SqlDbType.NVarChar, 15) { Value = (object)phone ?? DBNull.Value },
                    new SqlParameter("@addr", SqlDbType.NVarChar, 100) { Value = (object)model.Address ?? DBNull.Value },
                    new SqlParameter("@username", SqlDbType.NVarChar, 50) { Value = (object)model.Username ?? DBNull.Value },
                    // Password column is varbinary(64) in EDMX
                    new SqlParameter("@pwd", SqlDbType.VarBinary, 64) { Value = (object)pwd ?? DBNull.Value },
                    new SqlParameter("@created", SqlDbType.DateTime) { Value = DateTime.Now }
                };

                db.Database.ExecuteSqlCommand(sql, parameters);
            }

            TempData["Message"] = "Registration successful. You can now login.";
            return RedirectToAction("Login");
        }

        public ActionResult Logout()
        {
            Session.Clear();
            return RedirectToAction("Login");
        }

        // GET: Settings
        public ActionResult Settings()
        {
            if (Session["UserType"] == null) return RedirectToAction("Login");
            return View();
        }

        public ActionResult CustomerHome()
        {
            if (Session["UserType"] == null || Session["UserType"].ToString() != "Customer")
                return RedirectToAction("Login");

            string custId = Session["UserID"].ToString();
            var vm = new CustomerDashboardViewModel();

            using (var db = new BigBankEntities())
            {
                var customer = db.Customers.FirstOrDefault(c => c.CustID == custId);
                ViewBag.Customer = customer;

                var sb = db.SavingsAccounts.FirstOrDefault(s => s.CustID == custId);
                if (sb != null)
                {
                    vm.SavingsAccountID = sb.SBAccountID;
                    vm.SavingsBalance = sb.Balance;
                }

                vm.FDAccountIDs = db.FDAccounts.Where(f => f.CustomerID == custId).Select(f => f.FDAccountID).ToList();
                vm.LoanAccountIDs = db.LoanAccounts.Where(l => l.CustomerID == custId).Select(l => l.LoanAccountID).ToList();

                vm.TotalBalance = (vm.SavingsBalance ?? 0) + db.FDAccounts.Where(f => f.CustomerID == custId).Sum(f => (decimal?)f.Amount) ?? 0 + db.LoanAccounts.Where(l => l.CustomerID == custId).Sum(l => (decimal?)0) ?? 0;
            }

            return View(vm);
        }

        // Manager Home
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult ManagerHome()
        {
            if (Session["UserType"] == null || Session["UserType"].ToString() != "Manager")
                return RedirectToAction("Login");

            var vm = new BigBank.Models.ManagerDashboardViewModel();
            using (var db = new BigBankEntities())
            {
                vm.Customers = db.Customers.OrderBy(c => c.CustName).ToList();
                vm.Employees = db.Employees.OrderBy(e => e.EmpName).ToList();

                // collect recent savings transactions as a sample
                vm.RecentTransactions = db.SavingsTransactions.OrderByDescending(t => t.TransactionDate).Take(50).Select(t => new BigBank.Models.TransactionItem {
                    Id = t.TransactionID.ToString(),
                    AccountId = t.SBAccountID,
                    Date = t.TransactionDate,
                    Source = "Savings",
                    Type = t.TransactionType,
                    Amount = t.Amount,
                    Remarks = t.Remarks
                }).ToList();

                // summary stats
                vm.TotalCustomers = db.Customers.Count();
                vm.TotalEmployees = db.Employees.Count();
                vm.SavingsCount = db.SavingsAccounts.Count();
                vm.FDCount = db.FDAccounts.Count();
                vm.LoanCount = db.LoanAccounts.Count();
                vm.TotalAccounts = vm.SavingsCount + vm.FDCount + vm.LoanCount;

                // Active loans and Pending Loan Amount calculation
                // Get all loan accounts with Status = 'Active'
                var activeLoans = db.LoanAccounts.Where(l => l.Status == "Active").ToList();
                
                vm.ActiveLoansCount = 0;
                vm.PendingLoanAmount = 0m;
                
                foreach (var loan in activeLoans)
                {
                    // Get the latest transaction for this loan
                    var latestTxn = db.LoanTransactions
                        .Where(t => t.LoanAccountID == loan.LoanAccountID)
                        .OrderByDescending(t => t.TransactionID)
                        .FirstOrDefault();
                    
                    // Calculate outstanding amount
                    decimal outstanding = latestTxn?.Outstanding ?? loan.TotalPayable ?? loan.LoanAmount;
                    
                    // If outstanding > 0, count it as active and add to pending amount
                    if (outstanding > 0)
                    {
                        vm.ActiveLoansCount++;
                        vm.PendingLoanAmount += outstanding;
                    }
                }

               
                var since = DateTime.Now.AddDays(-7);
                var activeCustsFromSavings = db.SavingsTransactions.Where(t => t.TransactionDate >= since).Select(t => t.SBAccountID).ToList();
                // better approach: count distinct customers who had any transaction in last 7 days
                var activeCustomerIds = db.SavingsTransactions.Where(t => t.TransactionDate >= since).Select(t => t.SBAccountID).ToList();
                // approximate by distinct customers from account tables
                var activeFromSavingsCust = (from s in db.SavingsTransactions where s.TransactionDate >= since join acc in db.SavingsAccounts on s.SBAccountID equals acc.SBAccountID select acc.CustID).Distinct().Count();
                var activeFromFD = (from t in db.FDTransactions where t.TransactionDate >= since join f in db.FDAccounts on t.FDAccountID equals f.FDAccountID select f.CustomerID).Distinct().Count();
                var activeFromLoan = (from t in db.LoanTransactions where t.EMIDate >= since join l in db.LoanAccounts on t.LoanAccountID equals l.LoanAccountID select l.CustomerID).Distinct().Count();
                vm.ActiveUsers = activeFromSavingsCust + activeFromFD + activeFromLoan;

                // recent transactions: last 24 hours across savings, fd and loan
                var since24 = DateTime.Now.AddDays(-1);
                var recentSavings = db.SavingsTransactions.Count(t => t.TransactionDate >= since24);
                var recentFD = db.FDTransactions.Count(t => t.TransactionDate >= since24);
                var recentLoan = db.LoanTransactions.Count(t => t.EMIDate >= since24);
                vm.RecentTransactionsCount = recentSavings + recentFD + recentLoan;

                // also fill RecentTransactions list with up to 50 recent across savings for display
                vm.RecentTransactions = db.SavingsTransactions.Where(t => t.TransactionDate >= since24).OrderByDescending(t => t.TransactionDate).Take(50).Select(t => new BigBank.Models.TransactionItem {
                    Id = t.TransactionID.ToString(),
                    AccountId = t.SBAccountID,
                    Date = t.TransactionDate,
                    Source = "Savings",
                    Type = t.TransactionType,
                    Amount = t.Amount,
                    Remarks = t.Remarks
                }).ToList();
            }

            return View(vm);
        }

        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult ViewCustomers(string sort = "CreatedOn", string dir = "desc")
        {
            var customers = new List<Customer>();
            using (var db = new BigBankEntities())
            {
                IQueryable<Customer> q = db.Customers;
                // apply sorting
                bool ascending = string.Equals(dir, "asc", StringComparison.OrdinalIgnoreCase);
                switch (sort)
                {
                    case "CustID":
                        q = ascending ? q.OrderBy(c => c.CustID) : q.OrderByDescending(c => c.CustID);
                        break;
                    case "CustName":
                        q = ascending ? q.OrderBy(c => c.CustName) : q.OrderByDescending(c => c.CustName);
                        break;
                    case "PAN":
                        q = ascending ? q.OrderBy(c => c.PAN) : q.OrderByDescending(c => c.PAN);
                        break;
                    case "CreatedOn":
                    default:
                        q = ascending ? q.OrderBy(c => c.CreatedOn) : q.OrderByDescending(c => c.CreatedOn);
                        break;
                }

                customers = q.ToList();
            }

            ViewBag.SortColumn = sort;
            ViewBag.SortDir = dir;
            return View(customers);
        }

        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult ViewEmployees(string sort = "EmpName", string dir = "asc")
        {
            var employees = new List<Employee>();
            using (var db = new BigBankEntities())
            {
                IQueryable<Employee> q = db.Employees.Include("Department");
                bool ascending = string.Equals(dir, "asc", StringComparison.OrdinalIgnoreCase);

                // if sorting by Department (friendly name), fetch then sort in-memory
                if (string.Equals(sort, "Department", StringComparison.OrdinalIgnoreCase))
                {
                    employees = q.ToList();
                    Func<Employee, string> displayDept = e =>
                    {
                        if (!string.IsNullOrEmpty(e.EmpType) && e.EmpType.Trim().ToUpper() == "M") return "Manager";
                        var did = (e.DeptID ?? "").Trim().ToUpper();
                        switch (did)
                        {
                            case "SB": return "Savings";
                            case "LN": return "Loan";
                            case "FD": return "Fixed Deposits";
                            default: return e.Department != null ? e.Department.DeptName : (e.DeptID ?? string.Empty);
                        }
                    };

                    employees = ascending ? employees.OrderBy(displayDept).ThenBy(e => e.EmpName).ToList()
                                          : employees.OrderByDescending(displayDept).ThenBy(e => e.EmpName).ToList();
                }
                else
                {
                    switch (sort)
                    {
                        case "EmpID":
                            q = ascending ? q.OrderBy(e => e.EmpID) : q.OrderByDescending(e => e.EmpID);
                            break;
                        case "DeptID":
                            q = ascending ? q.OrderBy(e => e.DeptID) : q.OrderByDescending(e => e.DeptID);
                            break;
                        case "EmpName":
                        default:
                            q = ascending ? q.OrderBy(e => e.EmpName) : q.OrderByDescending(e => e.EmpName);
                            break;
                    }

                    employees = q.ToList();
                }
            }

            ViewBag.SortColumn = sort;
            ViewBag.SortDir = dir;
            return View(employees);
        }

        // Open FD
        public ActionResult OpenFD()
        {
            if (Session["UserType"] == null || Session["UserType"].ToString() != "Customer")
                return RedirectToAction("Login");

            var vm = new OpenFDViewModel();
            string custId = Session["UserID"].ToString();
            using (var db = new BigBankEntities())
            {
                var cust = db.Customers.FirstOrDefault(c => c.CustID == custId);
                if (cust != null)
                {
                    vm.CustomerDOB = cust.DOB;
                }
            }
            vm.StartDate = DateTime.Today;
            return View(vm);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult OpenFD(OpenFDViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);

            if (model.Amount < 10000m)
            {
                ModelState.AddModelError("Amount", "Minimum FD amount is 10000.");
                return View(model);
            }

            // compute end date and interest rate server-side to avoid tampering
            string custId = Session["UserID"].ToString();
            DateTime dob = DateTime.MinValue;
            using (var db = new BigBankEntities())
            {
                var cust = db.Customers.FirstOrDefault(c => c.CustID == custId);
                if (cust != null) dob = cust.DOB;

                // calculate senior flag
                bool isSenior = false;
                if (dob != DateTime.MinValue)
                {
                    var age = (int)((DateTime.Today - dob).TotalDays / 365.25);
                    isSenior = age >= 60;
                }

                // determine base interest rate by tenure
                decimal baseRate;
                if (model.Tenure <= 1) baseRate = 6.0m;
                else if (model.Tenure == 2) baseRate = 7.0m;
                else baseRate = 8.0m;

                if (isSenior) baseRate += 0.5m;

                model.InterestRate = baseRate;
                // ensure StartDate is set
                var start = model.StartDate == default(DateTime) ? DateTime.Today : model.StartDate;
                var end = start.AddYears(model.Tenure);
                model.EndDate = end;

                // check customer's savings balance
                var sb = db.SavingsAccounts.FirstOrDefault(s => s.CustID == custId);
                if (sb == null)
                {
                    ModelState.AddModelError("", "Savings account not found.");
                    model.CustomerDOB = cust != null ? (DateTime?)cust.DOB : null;
                    return View(model);
                }

                if (sb.Balance < model.Amount || sb.Balance - model.Amount < 1000m)
                {
                    // insufficient funds
                    TempData["Error"] = "Bank balance insufficient, please deposit.";
                    model.CustomerDOB = cust != null ? (DateTime?)cust.DOB : null;
                    return View(model);
                }

                // compute maturity amount (simple interest) and persist within transaction
                var maturityAmount = model.Amount + (model.Amount * (model.InterestRate / 100m) * model.Tenure);

                using (var tx = db.Database.BeginTransaction())
                {
                    try
                    {
                        // deduct from savings
                        var newBal = sb.Balance - model.Amount;
                        db.Database.ExecuteSqlCommand("UPDATE SavingsAccount SET Balance = @p0 WHERE SBAccountID = @p1", newBal, sb.SBAccountID);

                        var insertSql = @"INSERT INTO FDAccount (CustomerID, StartDate, EndDate, Amount, InterestRate, MaturityAmount, Tenure, Status)
                                          OUTPUT INSERTED.FDAccountID
                                          VALUES (@cust, @start, @end, @amt, @irate, @maturity, @tenure, @status)";
                        var insertParams = new[] {
                            new SqlParameter("@cust", SqlDbType.VarChar) { Value = custId },
                            new SqlParameter("@start", SqlDbType.Date) { Value = start },
                            new SqlParameter("@end", SqlDbType.Date) { Value = end },
                            new SqlParameter("@amt", SqlDbType.Decimal) { Value = model.Amount },
                            new SqlParameter("@irate", SqlDbType.Decimal) { Value = model.InterestRate },
                            new SqlParameter("@maturity", SqlDbType.Decimal) { Value = maturityAmount },
                            new SqlParameter("@tenure", SqlDbType.Int) { Value = model.Tenure },
                            new SqlParameter("@status", SqlDbType.NVarChar) { Value = "Active" }
                        };

                        var newFdId = db.Database.SqlQuery<string>(insertSql, insertParams).FirstOrDefault();

                        // insert a FDTransaction record for this opening
                        var processedBy = Session["Username"] != null ? Session["Username"].ToString() : null;
                        var txnSql = @"INSERT INTO FDTransaction (FDAccountID, TransactionDate, TransactionType, Amount, InterestRate, MaturityAmount, ProcessedBy, Remarks)
                                       VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @6, @7)";
                        db.Database.ExecuteSqlCommand(txnSql, newFdId, DateTime.Now, "Open", model.Amount, model.InterestRate, maturityAmount, (object)processedBy ?? DBNull.Value, "FD opened via web");

                        tx.Commit();
                    }
                    catch
                    {
                        tx.Rollback();
                        throw;
                    }
                }

                // read latest FD record for customer to show success details
                var fdrec = db.FDAccounts.Where(f => f.CustomerID == custId).OrderByDescending(f => f.FDAuto).FirstOrDefault();
                if (fdrec != null)
                {
                    TempData["FDSuccess"] = $"FD opened: {fdrec.FDAccountID}. Maturity Amount: Rs {fdrec.MaturityAmount.GetValueOrDefault():N2}. End Date: {fdrec.EndDate:yyyy-MM-dd}";
                }
            }

            return RedirectToAction("CustomerHome");
        }

        // Open Loan
        public ActionResult OpenLoan()
        {
            if (Session["UserType"] == null || Session["UserType"].ToString() != "Customer")
                return RedirectToAction("Login");

            return View(new OpenLoanViewModel());
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult OpenLoan(OpenLoanViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);

            if (model.LoanAmount < 10000m)
            {
                ModelState.AddModelError("LoanAmount", "Minimum Loan amount is 10000.");
                return View(model);
            }

            string custId = Session["UserID"].ToString();
            using (var db = new BigBankEntities())
            {
                var cust = db.Customers.FirstOrDefault(c => c.CustID == custId);
                if (cust != null)
                {
                }

                // senior citizen check via DOB
                var age = (int)((DateTime.Today - cust.DOB).TotalDays / 365.25);
                bool isSenior = age >= 60;
                if (isSenior && model.LoanAmount > 100000m)
                {
                    ModelState.AddModelError("LoanAmount", "Senior Citizens cannot be sanctioned a loan greater than Rs. 1,00,000.");
                    return View(model);
                }

                // interest rate by amount with senior override
                decimal interestRate = isSenior ? 9.5m : (model.LoanAmount <= 500000m ? 10.0m : (model.LoanAmount <= 1000000m ? 9.5m : 9.0m));

                // compute EMI and totals
                int months = model.Tenure * 12;
                decimal monthlyRate = (interestRate / 100m) / 12m;
                decimal emi;
                if (monthlyRate > 0)
                {
                    double factor = Math.Pow(1 + (double)monthlyRate, months);
                    emi = model.LoanAmount * monthlyRate * (decimal)factor / ((decimal)factor - 1);
                }
                else
                {
                    emi = months > 0 ? model.LoanAmount / months : 0m;
                }
                emi = Math.Round(emi, 2);
                var totalPayable = emi * months;
                var endDate = model.StartDate.AddYears(model.Tenure);

                try
                {
                    using (var tx = db.Database.BeginTransaction())
                    {
                        var insertSql = @"INSERT INTO LoanAccount (CustomerID, StartDate, EndDate, LoanAmount, InterestRate, Tenure, TotalPayable, Status)
                                           OUTPUT INSERTED.LoanAccountID
                                           VALUES (@custId, @startDate, @endDate, @loanAmount, @interestRate, @tenure, @totalPayable, @status)";

                        var newLoanId = db.Database.SqlQuery<string>(insertSql,
                            new SqlParameter("@custId", custId),
                            new SqlParameter("@startDate", model.StartDate),
                            new SqlParameter("@endDate", endDate),
                            new SqlParameter("@loanAmount", model.LoanAmount),
                            new SqlParameter("@interestRate", interestRate),
                            new SqlParameter("@tenure", months),
                            new SqlParameter("@totalPayable", totalPayable),
                            new SqlParameter("@status", "Active")
                        ).FirstOrDefault();

                        // Initial loan transaction with Outstanding
                        var processedBy = Session["UserID"] != null ? Session["UserID"].ToString() : null;
                        db.Database.ExecuteSqlCommand(
                            "INSERT INTO LoanTransaction (LoanAccountID, EMIDate, Amount, Outstanding, ProcessedBy, Remarks) VALUES (@p0, @p1, @p2, @p3, @p4, @p5)",
                            newLoanId, DateTime.Now, 0, totalPayable, (object)processedBy ?? DBNull.Value, "Loan account opened");

                        tx.Commit();

                        TempData["Success"] = $"Loan account opened successfully!<br/>Account Number: {newLoanId}<br/>EMI Amount: Rs. {emi:N2}<br/>Interest Rate: {interestRate}%<br/>Total Payable: Rs. {totalPayable:N2}";
                    }
                }
                catch (Exception ex)
                {
                    ModelState.AddModelError("", "Failed to create loan account: " + ex.Message);
                    return View(model);
                }
            }

            return RedirectToAction("CustomerHome");
        }

        // Manager: Open Loan Account for a customer
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult OpenLoanAccountManager()
        {
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult OpenLoanAccountManager(string CustID, decimal? LoanAmount, int? Tenure, DateTime? StartDate)
        {
            ViewBag.LastCustID = CustID;

            var errors = new List<string>();
            if (string.IsNullOrWhiteSpace(CustID)) errors.Add("Customer ID is required.");
            if (!LoanAmount.HasValue) errors.Add("Loan amount is required.");
            if (!Tenure.HasValue) errors.Add("Tenure is required.");
            if (!StartDate.HasValue) errors.Add("Start date is required.");
            if (LoanAmount.HasValue && LoanAmount.Value < 10000m) errors.Add("Minimum Loan amount is 10,000.");
            if (errors.Any())
            {
                TempData["Error"] = string.Join("<br/>", errors);
                return View();
            }

            using (var db = new BigBankEntities())
            {
                var cust = db.Customers.FirstOrDefault(c => c.CustID == CustID);
                if (cust == null)
                {
                    TempData["Error"] = "Customer not found.";
                    return View();
                }

                var age = (int)((DateTime.Today - cust.DOB).TotalDays / 365.25);
                bool isSenior = age >= 60;
                if (isSenior && LoanAmount.Value > 100000m)
                {
                    TempData["Error"] = "Senior Citizens cannot be sanctioned a loan greater than Rs. 1,00,000.";
                    return View();
                }

                decimal interestRate = isSenior ? 9.5m : (LoanAmount.Value <= 500000m ? 10.0m : (LoanAmount.Value <= 1000000m ? 9.5m : 9.0m));

                int months = Tenure.Value * 12;
                var startDate = StartDate.Value;
                var endDate = startDate.AddYears(Tenure.Value);
                decimal monthlyRate = (interestRate / 100m) / 12m;
                decimal emi;
                if (monthlyRate > 0)
                {
                    double factor = Math.Pow(1 + (double)monthlyRate, months);
                    emi = LoanAmount.Value * monthlyRate * (decimal)factor / ((decimal)factor - 1);
                }
                else
                {
                    emi = months > 0 ? LoanAmount.Value / months : 0m;
                }
                emi = Math.Round(emi, 2);
                var totalPayable = emi * months;

                string newLoanId = null;
                try
                {
                    using (var tx = db.Database.BeginTransaction())
                    {
                        var insertSql = @"INSERT INTO LoanAccount (CustomerID, StartDate, EndDate, LoanAmount, InterestRate, Tenure, TotalPayable, Status)
                                           OUTPUT INSERTED.LoanAccountID
                                           VALUES (@custId, @startDate, @endDate, @loanAmount, @interestRate, @tenure, @totalPayable, @status)";

                        newLoanId = db.Database.SqlQuery<string>(insertSql,
                            new SqlParameter("@custId", CustID),
                            new SqlParameter("@startDate", startDate),
                            new SqlParameter("@endDate", endDate),
                            new SqlParameter("@loanAmount", LoanAmount.Value),
                            new SqlParameter("@interestRate", interestRate),
                            new SqlParameter("@tenure", months),
                            new SqlParameter("@totalPayable", totalPayable),
                            new SqlParameter("@status", "Active")
                        ).FirstOrDefault();

                        var processedBy = Session["UserID"] != null ? Session["UserID"].ToString() : null;
                        db.Database.ExecuteSqlCommand(
                            "INSERT INTO LoanTransaction (LoanAccountID, EMIDate, Amount, Outstanding, ProcessedBy, Remarks) VALUES (@p0, @p1, @p2, @p3, @p4, @p5)",
                            newLoanId, DateTime.Now, 0, totalPayable, (object)processedBy ?? DBNull.Value, "Loan account opened by manager");

                        tx.Commit();
                    }
                }
                catch (Exception ex)
                {
                    TempData["Error"] = "Failed to create loan account: " + ex.Message;
                    return View();
                }

                TempData["Success"] = $"Loan account {newLoanId} created successfully!";
                ViewBag.NewLoanId = newLoanId;
                ViewBag.CustID = CustID;
                ViewBag.LoanAmount = LoanAmount.Value.ToString("N2");
                ViewBag.InterestRate = interestRate.ToString("N1");
                ViewBag.TenureYears = Tenure.Value;
                ViewBag.EMI = emi.ToString("N2");
                ViewBag.TotalPayable = totalPayable.ToString("N2");
                ViewBag.EndDate = endDate.ToString("dd-MMM-yyyy");

                return View();
            }
        }

        // ----- Loan: Pay EMI -----
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult PayEMI(string loanId = null)
        {
            ViewBag.LastLoanID = loanId;
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult PayEMI(string LoanAccountID, decimal? Amount)
        {
            if (string.IsNullOrWhiteSpace(LoanAccountID) || !Amount.HasValue || Amount.Value <= 0)
            {
                TempData["Error"] = "Loan Account ID and valid EMI amount are required.";
                ViewBag.LastLoanID = LoanAccountID;
                return View();
            }

            using (var db = new BigBankEntities())
            {
                var loan = db.LoanAccounts.FirstOrDefault(l => l.LoanAccountID == LoanAccountID);
                if (loan == null)
                {
                    TempData["Error"] = "Loan account not found.";
                    ViewBag.LastLoanID = LoanAccountID;
                    return View();
                }

                if (!string.Equals(loan.Status, "Active", StringComparison.OrdinalIgnoreCase))
                {
                    TempData["Error"] = "Loan account is not active.";
                    ViewBag.LastLoanID = LoanAccountID;
                    return View();
                }

                var latestTxn = db.LoanTransactions.Where(t => t.LoanAccountID == loan.LoanAccountID)
                                                    .OrderByDescending(t => t.TransactionID)
                                                    .FirstOrDefault();
                var outstanding = latestTxn?.Outstanding ?? loan.TotalPayable ?? loan.LoanAmount;
                if (outstanding <= 0)
                {
                    TempData["Error"] = "No outstanding amount. Loan might already be paid.";
                    ViewBag.LastLoanID = LoanAccountID;
                    return View();
                }

                decimal monthlyRate = (loan.InterestRate / 100m) / 12m;
                int months = loan.Tenure; // tenure stored in months
                decimal emi;
                if (monthlyRate > 0)
                {
                    double factor = Math.Pow(1 + (double)monthlyRate, months);
                    emi = loan.LoanAmount * monthlyRate * (decimal)factor / ((decimal)factor - 1);
                }
                else
                {
                    emi = months > 0 ? loan.LoanAmount / months : 0m;
                }
                emi = Math.Round(emi, 2);

                var payAmount = Amount.Value;
                if (outstanding < emi)
                {
                    if (Math.Round(payAmount, 2) != Math.Round(outstanding, 2))
                    {
                        TempData["Error"] = $"Final payment should be Rs {outstanding:N2}.";
                        ViewBag.LastLoanID = LoanAccountID;
                        return View();
                    }
                }
                else
                {
                    if (Math.Round(payAmount, 2) != Math.Round(emi, 2))
                    {
                        TempData["Error"] = $"Only current EMI of Rs {emi:N2} is allowed.";
                        ViewBag.LastLoanID = LoanAccountID;
                        return View();
                    }
                }

                var newOutstanding = Math.Max(0m, outstanding - payAmount);

                using (var tx = db.Database.BeginTransaction())
                {
                    try
                    {
                        var processedBy = Session["UserID"] != null ? Session["UserID"].ToString() : null;
                        db.Database.ExecuteSqlCommand(
                            "INSERT INTO LoanTransaction (LoanAccountID, EMIDate, Amount, Outstanding, ProcessedBy, Remarks) VALUES (@p0, @p1, @p2, @p3, @p4, @p5)",
                            loan.LoanAccountID, DateTime.Now, payAmount, newOutstanding, (object)processedBy ?? DBNull.Value, "Monthly EMI payment");

                        if (newOutstanding == 0)
                        {
                            db.Database.ExecuteSqlCommand("UPDATE LoanAccount SET Status = @p0 WHERE LoanAccountID = @p1", "Closed", loan.LoanAccountID);
                        }

                        tx.Commit();
                    }
                    catch (Exception ex)
                    {
                        tx.Rollback();
                        TempData["Error"] = "EMI payment failed: " + ex.Message;
                        ViewBag.LastLoanID = LoanAccountID;
                        return View();
                    }
                }

                TempData["Success"] = $"EMI of Rs {payAmount:N2} recorded. New outstanding: Rs {newOutstanding:N2}.";
                return RedirectToAction("ViewLoanAccounts");
            }
        }

        // Lookup loan details for UI
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult LookupLoanAccount(string id)
        {
            if (string.IsNullOrWhiteSpace(id))
                return Json(new { }, JsonRequestBehavior.AllowGet);

            using (var db = new BigBankEntities())
            {
                var loan = db.LoanAccounts.FirstOrDefault(l => l.LoanAccountID == id);
                if (loan == null)
                    return Json(new { }, JsonRequestBehavior.AllowGet);

                var latestTxn = db.LoanTransactions.Where(t => t.LoanAccountID == id)
                                                   .OrderByDescending(t => t.TransactionID)
                                                   .FirstOrDefault();
                decimal outstanding = latestTxn?.Outstanding ?? loan.TotalPayable ?? loan.LoanAmount;

                decimal monthlyRate = (loan.InterestRate / 100m) / 12m;
                int months = loan.Tenure;
                decimal emi;
                if (monthlyRate > 0)
                {
                    double factor = Math.Pow(1 + (double)monthlyRate, months);
                    emi = loan.LoanAmount * monthlyRate * (decimal)factor / ((decimal)factor - 1);
                }
                else
                {
                    emi = months > 0 ? loan.LoanAmount / months : 0m;
                }
                emi = Math.Round(emi, 2);

                var paidCount = db.LoanTransactions.Count(t => t.LoanAccountID == id && t.Amount > 0);
                var nextDue = loan.StartDate.AddMonths(paidCount + 1);

                var cust = db.Customers.FirstOrDefault(c => c.CustID == loan.CustomerID);
                return Json(new
                {
                    customerName = cust != null ? cust.CustName : string.Empty,
                    loanAmount = loan.LoanAmount,
                    outstanding = outstanding,
                    monthlyEMI = emi,
                    todaysDate = DateTime.Today.ToString("yyyy-MM-dd"),
                    nextDueDate = nextDue.ToString("yyyy-MM-dd"),
                    status = loan.Status
                }, JsonRequestBehavior.AllowGet);
            }
        }

        // ----- Loan: Foreclose (pay full outstanding and close) -----
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult ForeCloseLoan(string id = null)
        {
            ViewBag.LastLoanID = id;
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        [SessionAuthorize(RolesCsv = "Manager")]
        [NoCache]
        public ActionResult ForeCloseLoan(string LoanAccountID)
        {
            if (string.IsNullOrWhiteSpace(LoanAccountID))
            {
                TempData["Error"] = "Loan Account ID is required.";
                ViewBag.LastLoanID = LoanAccountID;
                return View();
            }

            using (var db = new BigBankEntities())
            {
                var loan = db.LoanAccounts.FirstOrDefault(l => l.LoanAccountID == LoanAccountID);
                if (loan == null)
                {
                    TempData["Error"] = "Loan account not found.";
                    ViewBag.LastLoanID = LoanAccountID;
                    return View();
                }

                if (!string.Equals(loan.Status, "Active", StringComparison.OrdinalIgnoreCase))
                {
                    TempData["Error"] = "Loan account is not active.";
                    ViewBag.LastLoanID = LoanAccountID;
                    return View();
                }

                var latestTxn = db.LoanTransactions.Where(t => t.LoanAccountID == loan.LoanAccountID)
                                                    .OrderByDescending(t => t.TransactionID)
                                                    .FirstOrDefault();
                var outstanding = latestTxn?.Outstanding ?? loan.TotalPayable ?? loan.LoanAmount;
                if (outstanding <= 0)
                {
                    TempData["Error"] = "No outstanding amount to foreclose.";
                    ViewBag.LastLoanID = LoanAccountID;
                    return View();
                }

                using (var tx = db.Database.BeginTransaction())
                {
                    try
                    {
                        var processedBy = Session["UserID"] != null ? Session["UserID"].ToString() : null;
                        db.Database.ExecuteSqlCommand(
                            "INSERT INTO LoanTransaction (LoanAccountID, EMIDate, Amount, Outstanding, ProcessedBy, Remarks) VALUES (@p0, @p1, @p2, @p3, @p4, @p5)",
                            loan.LoanAccountID, DateTime.Now, outstanding, 0, (object)processedBy ?? DBNull.Value, "Loan foreclosed - full outstanding paid");

                        db.Database.ExecuteSqlCommand("UPDATE LoanAccount SET Status = @p0 WHERE LoanAccountID = @p1", "Closed", loan.LoanAccountID);

                        tx.Commit();
                    }
                    catch (Exception ex)
                    {
                        tx.Rollback();
                        TempData["Error"] = "Foreclosure failed: " + ex.Message;
                        ViewBag.LastLoanID = LoanAccountID;
                        return View();
                    }
                }

                TempData["Success"] = $"Loan {LoanAccountID} foreclosed successfully. Amount paid: Rs {outstanding:N2}.";
                return RedirectToAction("ViewLoanAccounts");
            }
        }
    }
}